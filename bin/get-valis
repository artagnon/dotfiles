#!/bin/bash

TOPDIR=`pwd`
git clone git@github.com:llvm-mirror/llvm valis-llvm
cd valis-llvm/tools
git clone git@github.com:falcon-computing/valis polly
cd $TOPDIR/valis-llvm
mkdir build
cd build
CC=`which clang` CXX=`which clang++` cmake -GNinja \
    -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DPOLLY_ENABLE_GPGPU_CODEGEN=ON \
    -DLLVM_ENABLE_LIBCXX=ON \
    -DCMAKE_INSTALL_PREFIX=/curr/software/valis-llvm ..
LD_LIBRARY_PATH=/usr/local/lib ninja install
if [[ $? -eq 0 ]]; then
    echo '*********************************************************'
    echo '                valis has been installed                 '
    echo '      please use /curr/software/valis-llvm/bin/opt      '
    echo ' $ opt -O3 -analyze -polly-codegen-ppcg matmul.preopt.ll '
    echo '*********************************************************'
fi
